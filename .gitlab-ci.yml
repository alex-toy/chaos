image: docker:latest
services:
  - docker:dind


stages:
  - build
  - test
  - deploy

build-docker-image:
  stage: build
  variables:
    IMAGE_NAME: eu.gcr.io/yotta-square-ml3/$CI_PROJECT_NAME:$CI_COMMIT_BRANCH
  script:
  - echo "$GITLAB_IAM_PRIVATE_KEY" > key.json
  - docker build . -t $IMAGE_NAME
  - docker login -u _json_key -p "$(cat key.json)" $IMAGE_NAME
  - docker push $IMAGE_NAME

unit-test:
  image: python:3.8.5
  stage: test
  script: 
    - pip install -r requirements.txt
    - pip install -e .
    - pytest chaos/test/unit

deploy to staging:
  stage: deploy
  script: make deploy
  environment:
    name: staging
    url: https://staging.example.com/
